# smoove Dockerfile for WILDS Docker Library
# smoove: structural variant calling and genotyping with existing tools
FROM ubuntu:22.04

# Adding labels for the GitHub Container Registry following WILDS standards
LABEL org.opencontainers.image.title="smoove"
LABEL org.opencontainers.image.description="Container image for smoove (LUMPY wrapper) structural variant caller in WILDS"
LABEL org.opencontainers.image.version="0.2.8"
LABEL org.opencontainers.image.authors="wilds@fredhutch.org"
LABEL org.opencontainers.image.url=https://ocdo.fredhutch.org/
LABEL org.opencontainers.image.documentation=https://getwilds.org/
LABEL org.opencontainers.image.source=https://github.com/getwilds/wilds-docker-library
LABEL org.opencontainers.image.licenses=MIT

# Set the shell option to fail if any command in a pipe fails
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Set environment variables for non-interactive installation
ENV DEBIAN_FRONTEND=noninteractive

# Update package list and install dependencies
RUN apt-get update \
  && WGET_VERSION=$(apt-cache policy wget | grep Candidate | awk '{print $2}') \
  && LUMPY_VERSION=$(apt-cache policy lumpy-sv | grep Candidate | awk '{print $2}') \
  && SAMTOOLS_VERSION=$(apt-cache policy samtools | grep Candidate | awk '{print $2}') \
  && BCFTOOLS_VERSION=$(apt-cache policy bcftools | grep Candidate | awk '{print $2}') \
  && TABIX_VERSION=$(apt-cache policy tabix | grep Candidate | awk '{print $2}') \
  && apt-get install -y --no-install-recommends \
  wget="${WGET_VERSION}" \
  lumpy-sv="${LUMPY_VERSION}" \
  samtools="${SAMTOOLS_VERSION}" \
  bcftools="${BCFTOOLS_VERSION}" \
  tabix="${TABIX_VERSION}" \
  && rm -rf /var/lib/apt/lists/*

# Download and install smoove binary and additional tools it needs
WORKDIR /usr/local/bin
RUN wget -q --no-check-certificate https://github.com/brentp/smoove/releases/download/v0.2.8/smoove \
  && chmod +x smoove \
  && wget -q --no-check-certificate https://github.com/brentp/gsort/releases/download/v0.1.4/gsort_linux_amd64 \
  && chmod +x gsort_linux_amd64 \
  && mv gsort_linux_amd64 gsort \
  && wget -q --no-check-certificate https://github.com/brentp/mosdepth/releases/download/v0.3.6/mosdepth \
  && chmod +x mosdepth \
  && wget -q --no-check-certificate https://github.com/brentp/duphold/releases/download/v0.2.3/duphold \
  && chmod +x duphold

# Smoke test to verify tools are installed
RUN smoove --help \
  && lumpy --help || echo "lumpy installed" \
  && samtools --version \
  && bcftools --version \
  && tabix --version

# Set working directory
WORKDIR /data
